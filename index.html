<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Lebenscode Mandala</title>

  <link rel="stylesheet" href="app.css?v=1000" />
</head>

<body>
  <header class="app-header">
    <div class="brand">
      <img class="brand-logo" src="assets/Logo.png" alt="Milz & More Logo" />
      <div class="brand-text">
        <div class="brand-title">Lebenscode Mandala</div>
        <div class="brand-sub">von Milz & More</div>
      </div>
    </div>

    <div class="controls">
      <div class="field">
        <label>Modus</label>
        <select id="mode">
          <option value="geburtstag">Geburtstag</option>
          <option value="text">Text / Affirmation</option>
        </select>
      </div>

      <div class="field">
        <label>Eingabe</label>
        <input id="input" type="text" value="15011987" placeholder="z.B. 15011987 oder TEXT" />
      </div>

      <div class="field">
        <label>Richtung</label>
        <select id="direction">
          <option value="aussen">Außen</option>
          <option value="innen">Innen</option>
        </select>
      </div>

      <div class="field" id="sectorWrap" style="display:none;">
        <label>Sektor</label>
        <select id="sector">
          <option value="6">6</option>
          <option value="8" selected>8</option>
          <option value="10">10</option>
          <option value="12">12</option>
          <option value="13">13</option>
        </select>
      </div>

      <button id="download" class="primary" type="button">Download</button>
    </div>

    <div class="right">
      <label class="toggle">
        <input id="paperToggle" type="checkbox" checked />
        <span>Print-Look</span>
      </label>

      <nav class="engine-nav">
        <button class="engine-btn active" data-engine="quadrat" type="button">Quadrat</button>
        <button class="engine-btn" data-engine="rund" type="button">Rund</button>
        <button class="engine-btn" data-engine="wabe" type="button">Wabe</button>
      </nav>
    </div>
  </header>

  <main class="app-main">
    <aside class="slider-panel">
      <div class="slider-title">Farbintensität</div>
      <div id="sliders" class="sliders"></div>
      <div class="hint">Tipp: Slider regeln Sättigung/Helligkeit je Ziffer.</div>
    </aside>

    <section id="stage" class="stage paper">
      <div id="loading" class="loading">Engine lädt…</div>
      <iframe id="engineFrame" class="engine-frame" title="Mandala Engine"></iframe>
    </section>
  </main>

  <script>
    const state = {
      engine: "quadrat",
      mode: "geburtstag",
      input: "15011987",
      direction: "aussen",
      sector: 8,
      sliders: Array(10).fill(85),
      isAdmin: false,
      paperLook: true
    };

    const params = new URLSearchParams(location.search);
    if (params.get("access") === "milz_secret") state.isAdmin = true;

    const els = {
      stage: document.getElementById("stage"),
      frame: document.getElementById("engineFrame"),
      loading: document.getElementById("loading"),
      mode: document.getElementById("mode"),
      input: document.getElementById("input"),
      direction: document.getElementById("direction"),
      sectorWrap: document.getElementById("sectorWrap"),
      sector: document.getElementById("sector"),
      download: document.getElementById("download"),
      sliders: document.getElementById("sliders"),
      paperToggle: document.getElementById("paperToggle")
    };

    function showLoading() {
      els.loading.style.display = "grid";
      els.stage.classList.add("is-loading");
    }
    function hideLoading() {
      els.loading.style.display = "none";
      els.stage.classList.remove("is-loading");
    }

    function buildSliders() {
      els.sliders.innerHTML = "";
      for (let i = 1; i <= 9; i++) {
        const row = document.createElement("div");
        row.className = "slider-row";

        const dot = document.createElement("div");
        dot.className = "dot";
        dot.id = "dot" + i;

        const label = document.createElement("div");
        label.className = "digit";
        label.textContent = String(i);

        const input = document.createElement("input");
        input.type = "range";
        input.min = "20";
        input.max = "100";
        input.value = String(state.sliders[i] ?? 85);
        input.addEventListener("input", () => {
          state.sliders[i] = Number(input.value);
          pushStateToEngine();
        });

        row.appendChild(dot);
        row.appendChild(label);
        row.appendChild(input);
        els.sliders.appendChild(row);
      }
    }

    function setActiveEngineButton(engine) {
      document.querySelectorAll(".engine-btn").forEach(btn => {
        btn.classList.toggle("active", btn.dataset.engine === engine);
      });
    }

    function updateConditionalFields() {
      els.sectorWrap.style.display = (state.engine === "rund") ? "block" : "none";
    }

    function applyPaperLook() {
      els.stage.classList.toggle("paper", !!state.paperLook);
      els.stage.classList.toggle("dark", !state.paperLook);
    }

    function loadEngine(engine) {
      state.engine = engine;
      setActiveEngineButton(engine);
      updateConditionalFields();

      showLoading();

      const fallbackTimer = setTimeout(() => hideLoading(), 2500);

      els.frame.onload = () => {
        clearTimeout(fallbackTimer);
        hideLoading();
        pushStateToEngine();
      };

      // ✅ embed=1 erzwingt transparenten Engine-Hintergrund
      els.frame.src = `engines/${engine}/index.html?embed=1&v=${Date.now()}`;
    }

    function pushStateToEngine() {
      try { els.frame.contentWindow.postMessage({ type: "SET_STATE", payload: state }, "*"); } catch (_) {}
    }

    function requestExport() {
      try { els.frame.contentWindow.postMessage({ type: "EXPORT", payload: state }, "*"); } catch (_) {}
    }

    window.addEventListener("message", (ev) => {
      const msg = ev.data;
      if (!msg || typeof msg !== "object") return;

      if (msg.type === "READY") {
        hideLoading();
        pushStateToEngine();
      }

      if (msg.type === "COLORS" && Array.isArray(msg.colors)) {
        for (let i = 1; i <= 9; i++) {
          const dot = document.getElementById("dot" + i);
          if (dot && msg.colors[i-1]) dot.style.background = msg.colors[i-1];
        }
      }
    });

    document.querySelectorAll(".engine-btn").forEach(btn => {
      btn.addEventListener("click", () => loadEngine(btn.dataset.engine));
    });

    els.mode.addEventListener("change", () => { state.mode = els.mode.value; pushStateToEngine(); });
    els.input.addEventListener("input",  () => { state.input = els.input.value; pushStateToEngine(); });
    els.direction.addEventListener("change", () => { state.direction = els.direction.value; pushStateToEngine(); });
    els.sector.addEventListener("change", () => { state.sector = Number(els.sector.value); pushStateToEngine(); });
    els.download.addEventListener("click", requestExport);

    els.paperToggle.addEventListener("change", () => {
      state.paperLook = els.paperToggle.checked;
      applyPaperLook();
      pushStateToEngine();
    });

    buildSliders();
    applyPaperLook();
    loadEngine("quadrat");
  </script>
</body>
</html>
